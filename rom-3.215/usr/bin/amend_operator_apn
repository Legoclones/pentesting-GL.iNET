#!/bin/sh

operator=`uci -q get glconfig.modem.operator`
[ -z "$operator" ] && return 1

operator_path="/etc/${operator}_profile"
[ -e "$operator_path" ] || return 1

# fix apn
operator_name=`jsonfilter -i $operator_path -e @.operator`
[ "$operator_name" = "$operator" ] || return 1

bus=`uci -q get glconfig.modem.bus`
serving=`gl_modem -B $bus AT 'AT+QENG="servingcell"' |grep QENG |cut -d '"' -f 4 |grep [A-Z]`
[ -z "$serving" ] && return 1
[ "$serving" = "NOCONN" ] && return 1

for line in $(jsonfilter -i $operator_path -e @.at_cmd[*]); do
    [ -n $(echo $line | grep AT) ] && echo $line && gl_modem -B $bus AT $line
    sleep 1
    # [ -z $(echo $line | grep -E 'AT+QPOWD|AT!RESET|AT+CRESET|AT+ZRST') ] && sleep 1 || sleep 30
done

sleep 5
serving=`gl_modem -B $bus AT 'AT+QENG="servingcell"' |grep QENG |cut -d '"' -f 4 |grep [A-Z]`
echo $serving
[ "$serving" = "NOCONN"  ] && {
	# logger "modem_operator fix success"
	return 0
}
return 1