#!/bin/sh

. /usr/share/libubox/jshn.sh
. /lib/functions/gl_util.sh
. /lib/functions.sh

# 1.downloading
# 2.download_failed
# 3.download_ok
# 4.verify_ok
# 5.verify_failed
# 6.upgrading
# 7.upgrade_failed
# 8.local_upgrade
# 9.download_ipk
# 10.download_ipk_failed
# 11.sha256_check
# 12.sha256_check_failed
# 13.meta_verify
# 14.meta_verify_failed

firmware_url=$1
firmware_version=$2
firmware_type=$3
firmware_user=$4
hash_type=$5
hash_value=$6
bForce=$7
bKeepConfig=$8
upgrade_option=""

model=$(get_model)

#Download firmware
echo '1' > /tmp/upgrade_status
logger -t firmware_cloud_upgrade "Begin download firmware......"

curl -Ls --connect-timeout 5 $firmware_url --max-time 1800 -o /tmp/firmware.img >> /dev/null
echo '3' > /tmp/upgrade_status

#sha256 check
echo '11' > /tmp/upgrade_status
if [ "$hash_type" = "sha256" ];then
	sha256sum=$(sha256sum /tmp/firmware.img |awk '{print $1}')
else
	logger -t firmware_cloud_upgrade "Check the firmware sha256sum failed, exit,please try again!"
	echo '12' > /tmp/upgrade_status
	exit 0
fi

if [ "$hash_value" != "$sha256sum"  ]; then
	echo '12' > /tmp/upgrade_status
	logger -t firmware_cloud_upgrade "Check the firmware sha256sum failed, exit,please try again!"
	exit 0
fi

if [ "$bForce" = "-F" ];then
	append upgrade_option "-F"	
else
	echo '13' > /tmp/upgrade_status
	#meta verify
	sysupgrade -T /tmp/firmware.img
	json_load_file /tmp/sysupgrade.meta
	json_select version
	json_get_var upgrade_version release
	json_get_var upgrade_user firmware_user
	json_get_var upgrade_type firmware_type
	echo $upgrade_version $upgrade_user $upgrade_type

	json_select ..
	json_get_var version_sup supported_version

	if [ "$version_sup" != "0" ];then
		current_version=`cat /etc/glversion`
		if [ "$current_version" != "$version_sup" ];then
			echo '14' > /tmp/upgrade_status
			logger -t firmware_cloud_upgrade "Check supported_version failed, exit,please try again!"
			exit 0
		fi
	fi

	if [ "$upgrade_version" != "$firmware_version" ];then
		echo '14' > /tmp/upgrade_status
		logger -t firmware_cloud_upgrade "Check firmware_version failed, exit,please try again!"
		exit 0
	fi	

	upgrade_user=`echo $upgrade_user | tr '[a-z]' '[A-Z]'`
	firmware_user=`echo $firmware_user | tr '[a-z]' '[A-Z]'`
	if [ "$upgrade_user" != "$firmware_user" ];then
		echo '14' > /tmp/upgrade_status
		logger -t firmware_cloud_upgrade "Check firmware_user failed, exit,please try again!"
		exit 0
	fi	

	if [ "$upgrade_type" != "$firmware_type" ];then
		echo '14' > /tmp/upgrade_status
		logger -t firmware_cloud_upgrade "Check firmware_type failed, exit,please try again!"
		exit 0
	fi	
fi

append upgrade_option $bKeepConfig

#upgarde
echo '6' > /tmp/upgrade_status
logger -t firmware_cloud_upgrade "Begin to upgrading......"

/usr/bin/flashleds &
sleep 25
	
/sbin/sysupgrade $upgrade_option /tmp/firmware.img

### If you run here, the upgrade failed.
echo '7' > /tmp/upgrade_status
logger -t firmware_cloud_upgrade "Upgrade failed, exit."
ps | grep flashleds | grep -v grep | cut -d ' ' -f1 | xargs kill -9
/etc/init.d/led restart
/etc/init.d/gl_mqtt restart
/etc/init.d/lighttpd restart
