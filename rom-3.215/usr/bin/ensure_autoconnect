#!/bin/sh

bus=`uci -q get glconfig.modem.bus`
[ -z "$bus" ] && return 1
iface=modem_"$(echo "$bus"|sed 's/-/_/g'|sed 's/\./_/g')"
sim="$(gl_modem sim-status)"

enable=`uci -q get glconfig.modem.enable_log`
[ "$enable" = "1" ] && echo `date` "=== sh ensure_autoconnect now" >> /etc/log/verizon_error.log

[ -z "$(uci -q get network.$iface)" ] && [ "$sim" != "READY" ] && {
    num=0
    until [ ! $num -lt 100 ]
    do
        [ "$sim" = "READY" ] && {
            [ "$enable" = "1" ] && echo `date` " === autoconnect success" >> /etc/log/verizon_error.log
            gl_modem -B "$bus" connect-auto &
            break
        }

        [ -n "$(uci -q get network.$iface)" ] && {
            [ "$enable" = "1" ] && echo `date` " === modem Manual Setup set uci, so break " >> /etc/log/verizon_error.log
            break
        }

        sim=`gl_modem sim-status`
        num=`expr $num + 1`
        sleep 6
    done
}
