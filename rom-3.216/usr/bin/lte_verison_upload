#!/bin/sh

count=0
while true
do
	if [ $count -gt 60 ];then
		break
	fi

	tmp=''
	tmp=`gl_modem AT AT+QGMR | grep EP06`
	if [ "$tmp" = "" ];then
		tmp=`gl_modem AT AT+QGMR | grep EC25`
	fi

	version=''
	version=${tmp%?}

	if [ "$version" = "" ];then
		count=$((count+1))
		sleep 60
		continue
	else
		ping -c 2 -W 2 8.8.8.8
		if [ $? -eq 0 ];then
			ubus call mqtt notify
			exit
		else
			count=$((count+1))
			sleep 60
			continue
		fi
	fi
done

/etc/init.d/gl_mqtt restart
