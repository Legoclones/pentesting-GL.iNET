#!/bin/sh

bus=`uci -q get glconfig.modem.bus`

[ ! -e "/tmp/sim_status" ] && echo ready > /tmp/sim_status
status=`gl_modem -B $bus AT AT+CPIN?`
[ -z "$status" ] && {
    [ -z "$status" ] && sleep 2 && status=`gl_modem -B $bus AT AT+CPIN?`
    [ -z "$status" ] && sleep 2 && status=`gl_modem -B $bus AT AT+CPIN?`
    [ -z "$status" ] && sleep 2 && status=`gl_modem -B $bus AT AT+CPIN?`
    [ -z "$status" ] && echo error > /tmp/sim_status
}
[ -n "$status" ] && {
    status=`gl_modem -B $bus AT AT+CPIN? | awk -F ': ' '{print $2}'`
    [ `echo $status | grep 'READY'` ] && echo ready > /tmp/sim_status
    [ `echo $status | grep 'SIM failure'` ] && echo error > /tmp/sim_status
    [ `echo $status | grep 'SIM PIN'` ] && echo pin > /tmp/sim_status
}

[ ! -e "/tmp/sim_type" ] && echo verizon > /tmp/sim_type
[ "`cat /tmp/sim_status 2>/dev/null`" = "ready" ] && {
    cimi=$(gl_modem -B $bus AT 'AT+CIMI' | tr -cd "[0-9]")
    code=${cimi:0:6}
    [ ${#code} == 6 ] && [ "$code" = "311480" -o "$code" = "311270" ] && echo verizon > /tmp/sim_type
    [ ${#code} == 6 ] && [ "$code" != "311480" -a "$code" != "311270" ] && echo generic > /tmp/sim_type
}