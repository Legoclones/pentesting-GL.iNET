#!/bin/sh
. /lib/functions/gl_util.sh

# model=$(awk -F': ' '/machine/ {print tolower($NF)}' /proc/cpuinfo |cut -d- -f2-)

# [ -n "$(grep "DK01" /proc/device-tree/model 2>/dev/null)" ] && model="b1300"
# [ -n "$(grep "DK04" /proc/device-tree/model 2>/dev/null)" ] && model="s1300"

model=$(get_model)

led="/dev/null"

case "$model" in
	"ar150"|\
	"mifi"|\
	"ar300"|\
	"ar300m")
		led="/sys/class/leds/gl-${model}:green:lan/brightness"
		;;
	"x300b")
		led="/sys/class/leds/gl-${model}:green:wan/brightness"
		;;
	"mt300a"|\
	"mt300n"|\
	"mt300n-v2")
		led="/sys/class/leds/gl-${model}:green:wan/brightness"
		;;
	"usb150")
		led="/sys/class/leds/gl-${model}:green:power/brightness"
		;;
	"ar750s"|\
	"ar750")
		led="/sys/class/leds/gl-$model:white:power/brightness"
		;;		
	"x750")
		led="/sys/class/leds/gl-$model:green:power/brightness"
		;;		
	"b1300"|\
	"s1300")
		led="/sys/class/leds/power_led/brightness"
		;;
	"b2200")
		led="/sys/class/leds/power_white_led/brightness"
		;;
	"x1200")
		led="/sys/class/leds/gl-${model}:red:system/brightness"
		;;
	"xe300")
		led="/sys/class/leds/gl-${model}:green:wan/brightness"
		;;
	"n300")
		echo 0 > /sys/class/leds/microuter-n300\:white\:wlan/brightness
		led="/sys/class/leds/microuter-${model}:blue:power/brightness"
		;;
	"mt1300")
		/etc/init.d/led stop
		;;
	"mv1000")
		led="/sys/class/leds/gl-mv1000:green:power/brightness"
		;;
	*)
esac

reset_pressed_start=$(date +%s)
reset_pressed_duration=0
reset_pressed_last=0
echo "$reset_pressed_duration" > /tmp/reset_pressed_duration
while [ true ]; do
	now=$(date +%s)
	reset_pressed_duration=$((now-reset_pressed_start))
	echo "$reset_pressed_duration" > /tmp/reset_pressed_duration
	#echo "$reset_pressed_duration" > /dev/console
	[ "$model" = "e750" -a "$reset_pressed_last" != "$reset_pressed_duration" ] && {
		reset_pressed_last=$reset_pressed_duration
		echo {\"button\":\"${reset_pressed_duration}\"} >/tmp/mcu_message
		killall -17 e750-mcu
	}
	#flash leds
	if [ "$reset_pressed_duration" -gt 20 ]; then
		sleep 1
	elif [ "$reset_pressed_duration" -gt 8 ]; then
		[ "$model" == "mt1300" ] && mt1300_led blue_flash fast
		echo 1 > $led
		usleep 100000
		echo 0 > $led
		usleep 100000
		echo 1 > $led
		usleep 100000
		echo 0 > $led
		usleep 100000
		echo 1 > $led
		usleep 100000
		echo 0 > $led
		usleep 100000
		echo 1 > $led
		usleep 100000
		echo 0 > $led
		usleep 100000
	elif [ "$reset_pressed_duration" -gt 3 ]; then
		[ "$model" == "mt1300" ] && mt1300_led blue_flash medium
		echo 1 > $led
		usleep 250000
		echo 0 > $led
		usleep 250000
	else
		if [ "$model" == "mt1300" ]; then
			mt1300_led blue_flash normal
			sleep 1
		else
			echo 1 > $led
			usleep 500000
			echo 0 > $led
			usleep 500000
		fi
	fi
done
